<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMS 6.0 - Advanced Student Management System</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0C2B4E 0%, #1A3D64 100%);
      min-height: 100%;
      overflow-x: hidden;
    }

    html, body {
      height: 100%;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 20px;
      height: 100%;
      box-sizing: border-box;
    }

    /* Home Page Styles */
    .home-page {
      text-align: center;
      padding: 40px 20px;
      animation: fadeIn 0.8s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo-container {
      margin-bottom: 30px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .logo {
      font-size: 80px;
      background: linear-gradient(45deg, #1D546C, #1A2A80, #3B38A0, #7A85C1);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 3s ease infinite;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .subtitle {
      color: white;
      font-size: 24px;
      margin-bottom: 40px;
      animation: slideIn 1s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-50px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .animation-container {
      margin: 40px 0;
      min-height: 300px;
      position: relative;
    }

    .teacher-animation, .student-animation {
      font-size: 100px;
      position: absolute;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-30px) rotate(5deg); }
    }

    .teacher-animation {
      left: 20%;
      top: 50px;
      animation-delay: 0s;
    }

    .student-animation {
      right: 20%;
      top: 80px;
      animation-delay: 0.5s;
    }

    .data-flow {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 60px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
    }

    .login-buttons {
      display: flex;
      gap: 30px;
      justify-content: center;
      margin-top: 50px;
    }

    .login-btn {
      padding: 20px 50px;
      font-size: 20px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }

    .login-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .login-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .student-login-btn {
      background: linear-gradient(135deg, #1A2A80 0%, #3B38A0 100%);
      color: white;
    }

    .admin-login-btn {
      background: linear-gradient(135deg, #1D546C 0%, #7A85C1 100%);
      color: white;
    }

    .teacher-login-btn {
      background: linear-gradient(135deg, #0C2B4E 0%, #B2B0E8 100%);
      color: white;
    }

    .login-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }

    /* Login Page Styles */
    .login-page {
      display: none;
      animation: fadeIn 0.5s ease-in;
      max-width: 500px;
      margin: 50px auto;
    }

    .login-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(50px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: rotate 4s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .login-title {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
      font-size: 14px;
    }

    .input-wrapper {
      position: relative;
    }

    .form-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #1A3D64;
      box-shadow: 0 0 0 3px rgba(26, 61, 100, 0.1);
    }

    .password-toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 20px;
      user-select: none;
    }

    .submit-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #0C2B4E 0%, #1A3D64 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(12, 43, 78, 0.4);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .back-btn {
      width: 100%;
      padding: 12px;
      background: #f0f0f0;
      color: #666;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: #e0e0e0;
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    /* Dashboard Styles */
    .dashboard {
      display: none;
      animation: fadeIn 0.5s ease-in;
      height: 100%;
    }

    .dashboard.active {
      display: flex;
      flex-direction: row;
      height: 100%;
    }

    .sidebar {
      width: 300px;
      min-width: 300px;
      background: linear-gradient(180deg, #0C2B4E 0%, #1A3D64 100%);
      border-radius: 20px;
      padding: 20px;
      margin-right: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: slideInLeft 0.6s ease-out;
      position: relative;
      overflow-y: auto;
      height: 100%;
      flex-shrink: 0;
    }

    .sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
      pointer-events: none;
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-50px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
    }

    .sidebar-logo {
      font-size: 48px;
      margin-bottom: 10px;
      animation: rotate 4s linear infinite;
    }

    .sidebar-title {
      color: white;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .sidebar-subtitle {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
    }

    .user-profile {
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: center;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(10px);
    }

    .user-avatar {
      font-size: 50px;
      margin-bottom: 10px;
      animation: bounce 2s infinite;
    }

    .user-name {
      color: white;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .user-role {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
      margin-bottom: 15px;
    }

    .logout-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .nav-menu {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 15px 20px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: left;
      gap: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .nav-item:hover {
      background: rgba(255,255,255,0.2);
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .nav-item.active {
      background: rgba(255,255,255,0.3);
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      transform: translateX(5px);
    }

    .nav-icon {
      font-size: 20px;
      width: 24px;
      text-align: center;
    }

    .main-content {
      flex: 1;
      animation: slideInRight 0.6s ease-out;
      height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .content-header {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .content-title {
      font-size: 28px;
      color: #333;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .content-title-icon {
      font-size: 32px;
      animation: pulse 2s ease-in-out infinite;
    }

    .tab-content {
      display: none;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease-in;
      position: relative;
      overflow: hidden;
      flex: 1;
      overflow-y: auto;
      width: 100%;
    }

    .tab-content::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 200px;
      height: 200px;
      background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 50%;
      transform: translate(50%, -50%);
      pointer-events: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Overview Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #0C2B4E 0%, #1A3D64 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      animation: scaleIn 0.5s ease-out;
      transition: all 0.3s ease;
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .stat-card:nth-child(2) {
      background: linear-gradient(135deg, #1D546C 0%, #1A2A80 100%);
    }

    .stat-card:nth-child(3) {
      background: linear-gradient(135deg, #3B38A0 0%, #7A85C1 100%);
    }

    .stat-card:nth-child(4) {
      background: linear-gradient(135deg, #1A2A80 0%, #B2B0E8 100%);
    }

    .stat-card:nth-child(5) {
      background: linear-gradient(135deg, #1D546C 0%, #3B38A0 100%);
    }

    .stat-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 16px;
      opacity: 0.9;
    }

    /* Table Styles */
    .table-container {
      overflow-x: auto;
      animation: fadeIn 0.6s ease-in;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    th {
      background: linear-gradient(135deg, #0C2B4E 0%, #1A3D64 100%);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    tr {
      transition: all 0.3s ease;
    }

    tr:hover {
      background: #f5f5f5;
      transform: scale(1.01);
    }

    .action-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      margin-right: 5px;
    }

    .edit-btn {
      background: #7A85C1;
      color: white;
    }

    .delete-btn {
      background: #1D546C;
      color: white;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .add-btn {
      padding: 12px 30px;
      background: linear-gradient(135deg, #1A2A80 0%, #3B38A0 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin-top: 20px;
      transition: all 0.3s ease;
    }

    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(26, 42, 128, 0.4);
    }

    /* Loading Spinner */
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1A3D64;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Student Profile Card */
    .profile-card {
      background: linear-gradient(135deg, #0C2B4E 0%, #1A3D64 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: slideIn 0.6s ease-out;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .profile-avatar {
      font-size: 80px;
      animation: bounce 2s infinite;
    }

    .profile-details h2 {
      font-size: 28px;
      margin-bottom: 5px;
    }

    .profile-details p {
      opacity: 0.9;
      font-size: 16px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .info-item {
      background: rgba(255,255,255,0.2);
      padding: 15px;
      border-radius: 10px;
    }

    .info-label {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 20px;
      font-weight: bold;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      animation: fadeIn 0.3s ease-in;
    }

    .modal-content {
      background: white;
      max-width: 600px;
      margin: 50px auto;
      padding: 30px;
      border-radius: 15px;
      max-height: 80%;
      overflow-y: auto;
      animation: slideUp 0.4s ease-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 24px;
      color: #333;
    }

    .close-btn {
      font-size: 30px;
      cursor: pointer;
      color: #999;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      color: #333;
      transform: rotate(90deg);
    }

    .save-btn {
      padding: 12px 30px;
      background: linear-gradient(135deg, #0C2B4E 0%, #1A3D64 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin-top: 20px;
      transition: all 0.3s ease;
    }

    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(12, 43, 78, 0.4);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .login-buttons {
        flex-direction: column;
      }

      .teacher-animation, .student-animation {
        position: static;
        display: inline-block;
        margin: 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .tabs {
        overflow-x: auto;
      }
    }

    /* Success Message */
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      animation: slideDown 0.5s ease-out;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div class="container"><!-- Home Page -->
   <div id="homePage" class="home-page">
    <div class="logo-container">
     <div class="logo">
      üìö SMS 6.0
     </div>
    </div>
    <h1 class="subtitle" id="websiteTitle">Students Management System - Version 6.0</h1>
    <div class="animation-container">
     <div class="teacher-animation">
      üë©‚Äçüè´
     </div>
     <div class="data-flow">
      üìä
     </div>
     <div class="student-animation">
      üë®‚Äçüéì
     </div>
    </div>
    <div class="login-buttons"><button class="login-btn admin-login-btn" onclick="showAdminLogin()"> üë®‚Äçüíº Admin Login </button> <button class="login-btn teacher-login-btn" onclick="showTeacherLogin()"> üë©‚Äçüè´ Teacher Login </button> <button class="login-btn student-login-btn" onclick="showStudentLogin()"> üë®‚Äçüéì Student Login </button>
    </div>
   </div><!-- Student Login Page -->
   <div id="studentLoginPage" class="login-page">
    <div class="login-card">
     <div class="login-header">
      <div class="login-icon">
       üë®‚Äçüéì
      </div>
      <h2 class="login-title">Student Login</h2>
     </div>
     <div id="studentLoginError" class="error-message"></div>
     <form id="studentLoginForm" onsubmit="handleStudentLogin(event)">
      <div class="form-group"><label class="form-label" for="studentEmail">Email ID</label> <input type="email" id="studentEmail" class="form-input" placeholder="24bit101@xxx.com" required>
      </div>
      <div class="form-group"><label class="form-label" for="studentPassword">Password</label>
       <div class="input-wrapper"><input type="password" id="studentPassword" class="form-input" placeholder="Enter your password" required> <span class="password-toggle" onclick="togglePassword('studentPassword')">üëÅÔ∏è</span>
       </div>
      </div><button type="submit" class="submit-btn" id="studentLoginBtn">Login</button> <button type="button" class="back-btn" onclick="showHome()">Back to Home</button>
     </form>
    </div>
   </div><!-- Admin Login Page -->
   <div id="adminLoginPage" class="login-page">
    <div class="login-card">
     <div class="login-header">
      <div class="login-icon">
       üë®‚Äçüíº
      </div>
      <h2 class="login-title">Admin Login</h2>
     </div>
     <div id="adminLoginError" class="error-message"></div>
     <form id="adminLoginForm" onsubmit="handleAdminLogin(event)">
      <div class="form-group"><label class="form-label" for="adminEmail">Email ID</label> <input type="email" id="adminEmail" class="form-input" placeholder="admin@xxx.com" required>
      </div>
      <div class="form-group"><label class="form-label" for="adminPassword">Password</label>
       <div class="input-wrapper"><input type="password" id="adminPassword" class="form-input" placeholder="Enter your password" required> <span class="password-toggle" onclick="togglePassword('adminPassword')">üëÅÔ∏è</span>
       </div>
      </div><button type="submit" class="submit-btn" id="adminLoginBtn">Login</button> <button type="button" class="back-btn" onclick="showHome()">Back to Home</button>
     </form>
    </div>
   </div><!-- Teacher Login Page -->
   <div id="teacherLoginPage" class="login-page">
    <div class="login-card">
     <div class="login-header">
      <div class="login-icon">
       üë©‚Äçüè´
      </div>
      <h2 class="login-title">Teacher Login</h2>
     </div>
     <div id="teacherLoginError" class="error-message"></div>
     <form id="teacherLoginForm" onsubmit="handleTeacherLogin(event)">
      <div class="form-group"><label class="form-label" for="teacherEmail">Email ID</label> <input type="email" id="teacherEmail" class="form-input" placeholder="teacher@xxx.com" required>
      </div>
      <div class="form-group"><label class="form-label" for="teacherPassword">Password</label>
       <div class="input-wrapper"><input type="password" id="teacherPassword" class="form-input" placeholder="Enter your password" required> <span class="password-toggle" onclick="togglePassword('teacherPassword')">üëÅÔ∏è</span>
       </div>
      </div><button type="submit" class="submit-btn" id="teacherLoginBtn">Login</button> <button type="button" class="back-btn" onclick="showHome()">Back to Home</button>
     </form>
    </div>
   </div><!-- Dashboard -->
   <div id="dashboard" class="dashboard"><!-- Sidebar -->
    <div class="sidebar">
     <div class="sidebar-header">
      <div class="sidebar-logo">
       üìö
      </div>
      <div class="sidebar-title">
       SMS 6.0
      </div>
      <div class="sidebar-subtitle">
       Advanced Management System
      </div>
     </div>
     <div class="user-profile">
      <div class="user-avatar" id="userAvatar">
       üë®‚Äçüéì
      </div>
      <div class="user-name" id="userName"></div>
      <div class="user-role" id="userRole"></div><button class="logout-btn" onclick="logout()">Logout</button>
     </div>
     <nav class="nav-menu"><button class="nav-item active" onclick="showTab('overview')"> <span class="nav-icon">üìä</span> <span>Overview</span> </button> <button class="nav-item" onclick="showTab('students')"> <span class="nav-icon">üë®‚Äçüéì</span> <span>Students</span> </button> <button class="nav-item" id="teachersNavItem" onclick="showTab('teachers')"> <span class="nav-icon">üë©‚Äçüè´</span> <span>Teachers</span> </button> <button class="nav-item" onclick="showTab('attendance')"> <span class="nav-icon">üïí</span> <span>Attendance</span> </button> <button class="nav-item" onclick="showTab('results')"> <span class="nav-icon">üìà</span> <span>Results</span> </button> <button class="nav-item" onclick="showTab('fees')"> <span class="nav-icon">üí∞</span> <span>Fees</span> </button> <button class="nav-item" onclick="showTab('library')"> <span class="nav-icon">üìö</span> <span>Library</span> </button> <button class="nav-item" onclick="showTab('assignments')"> <span class="nav-icon">üìù</span> <span>Assignments</span> </button> <button class="nav-item" onclick="showTab('events')"> <span class="nav-icon">üìÖ</span> <span>Events</span> </button> <button class="nav-item" onclick="showTab('messages')"> <span class="nav-icon">üí¨</span> <span>Messages</span> </button>
     </nav>
    </div><!-- Main Content -->
    <div class="main-content">
     <div class="content-header">
      <h1 class="content-title"><span class="content-title-icon" id="contentIcon">üìä</span> <span id="contentTitle">Dashboard Overview</span></h1>
     </div><!-- Overview Tab -->
     <div id="overviewTab" class="tab-content active">
      <h2 style="margin-bottom: 20px; color: #333;">Dashboard Overview</h2>
      <div class="stats-grid" id="statsGrid"></div>
      <div id="studentProfile" style="display: none;">
       <div class="profile-card">
        <div class="profile-header">
         <div class="profile-avatar">
          üë®‚Äçüéì
         </div>
         <div class="profile-details">
          <h2 id="profileName"></h2>
          <p id="profileRoll"></p>
          <p id="profileEmail"></p>
         </div>
        </div>
        <div class="info-grid">
         <div class="info-item">
          <div class="info-label">
           Department
          </div>
          <div class="info-value" id="profileDept"></div>
         </div>
         <div class="info-item">
          <div class="info-label">
           Attendance
          </div>
          <div class="info-value" id="profileAttendance"></div>
         </div>
         <div class="info-item">
          <div class="info-label">
           CGPA
          </div>
          <div class="info-value" id="profileCGPA"></div>
         </div>
         <div class="info-item">
          <div class="info-label">
           Assignments
          </div>
          <div class="info-value" id="profileAssignments"></div>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Students Tab -->
     <div id="studentsTab" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
       <h2 style="color: #333;">Students List</h2><button id="addStudentBtn" class="add-btn" onclick="showAddStudentModal()" style="display: none;"> ‚ûï Add Student </button>
      </div>
      <div class="table-container">
       <table id="studentsTable">
        <thead>
         <tr>
          <th>Roll No</th>
          <th>Name</th>
          <th>Email</th>
          <th>Department</th>
          <th>Phone</th>
          <th id="studentActionsHeader" style="display: none;">Actions</th>
         </tr>
        </thead>
        <tbody id="studentsTableBody"></tbody>
       </table>
      </div>
     </div><!-- Teachers Tab -->
     <div id="teachersTab" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
       <h2 style="color: #333;">Teachers List</h2><button id="addTeacherBtn" class="add-btn" onclick="showAddTeacherModal()" style="display: none;"> ‚ûï Add Teacher </button>
      </div>
      <div class="table-container">
       <table id="teachersTable">
        <thead>
         <tr>
          <th>Teacher ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Subject</th>
          <th>Phone</th>
          <th id="teacherActionsHeader" style="display: none;">Actions</th>
         </tr>
        </thead>
        <tbody id="teachersTableBody"></tbody>
       </table>
      </div>
     </div><!-- Attendance Tab -->
     <div id="attendanceTab" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #333;">Attendance Management</h2>
      <div id="attendanceContent"></div>
     </div><!-- Results Tab -->
     <div id="resultsTab" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #333;">Results &amp; Grades</h2>
      <div id="resultsContent"></div>
     </div><!-- Fees Tab -->
     <div id="feesTab" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #333;">Fee Management</h2>
      <div id="feesContent"></div>
     </div><!-- Library Tab -->
     <div id="libraryTab" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #333;">Library Records</h2>
      <div id="libraryContent"></div>
     </div><!-- Assignments Tab -->
     <div id="assignmentsTab" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #333;">Assignments</h2>
      <div id="assignmentsContent"></div>
     </div><!-- Events Tab -->
     <div id="eventsTab" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #333;">Events &amp; Activities</h2>
      <div id="eventsContent"></div>
     </div><!-- Messages Tab -->
     <div id="messagesTab" class="tab-content">
      <h2 style="margin-bottom: 20px; color: #333;">Messages</h2>
      <div id="messagesContent"></div>
     </div>
    </div><!-- Loading Spinner -->
    <div id="loading" class="loading">
     <div class="spinner"></div>
     <p style="margin-top: 20px; color: white;">Loading...</p>
    </div><!-- Add/Edit Teacher Modal -->
    <div id="teacherModal" class="modal">
     <div class="modal-content">
      <div class="modal-header">
       <h2 class="modal-title" id="teacherModalTitle">Add Teacher</h2><span class="close-btn" onclick="closeTeacherModal()">√ó</span>
      </div>
      <div id="teacherModalError" class="error-message"></div>
      <div id="teacherModalSuccess" class="success-message"></div>
      <form id="teacherForm" onsubmit="handleTeacherSubmit(event)">
       <div class="form-grid">
        <div class="form-group"><label class="form-label" for="teacherModalId">Teacher ID</label> <input type="text" id="teacherModalId" class="form-input" placeholder="TCH001" required>
        </div>
        <div class="form-group"><label class="form-label" for="teacherModalName">Name</label> <input type="text" id="teacherModalName" class="form-input" placeholder="Teacher Name" required>
        </div>
        <div class="form-group"><label class="form-label" for="teacherModalEmail">Email</label> <input type="email" id="teacherModalEmail" class="form-input" placeholder="teacher@xxx.com" required>
        </div>
        <div class="form-group"><label class="form-label" for="teacherModalPassword">Password</label> <input type="password" id="teacherModalPassword" class="form-input" placeholder="Password" required>
        </div>
        <div class="form-group"><label class="form-label" for="teacherModalSubject">Subject</label> <input type="text" id="teacherModalSubject" class="form-input" placeholder="Subject" required>
        </div>
        <div class="form-group"><label class="form-label" for="teacherModalPhone">Phone</label> <input type="tel" id="teacherModalPhone" class="form-input" placeholder="Phone Number" required>
        </div>
        <div class="form-group"><label class="form-label" for="teacherModalDepartment">Department</label> <input type="text" id="teacherModalDepartment" class="form-input" value="B.Sc.IT" required>
        </div>
        <div class="form-group"><label class="form-label" for="teacherModalExperience">Experience (Years)</label> <input type="number" id="teacherModalExperience" class="form-input" min="0" value="5" required>
        </div>
       </div><button type="submit" class="save-btn" id="saveTeacherBtn">Save Teacher</button>
      </form>
     </div>
    </div><!-- Add/Edit Student Modal -->
    <div id="studentModal" class="modal">
     <div class="modal-content">
      <div class="modal-header">
       <h2 class="modal-title" id="modalTitle">Add Student</h2><span class="close-btn" onclick="closeStudentModal()">√ó</span>
      </div>
      <div id="modalError" class="error-message"></div>
      <div id="modalSuccess" class="success-message"></div>
      <form id="studentForm" onsubmit="handleStudentSubmit(event)">
       <div class="form-grid">
        <div class="form-group"><label class="form-label" for="modalRollNumber">Roll Number</label> <input type="text" id="modalRollNumber" class="form-input" placeholder="24BIT101" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalName">Name</label> <input type="text" id="modalName" class="form-input" placeholder="Student Name" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalEmail">Email</label> <input type="email" id="modalEmail" class="form-input" placeholder="24bit101@xxx.com" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalPassword">Password</label> <input type="password" id="modalPassword" class="form-input" placeholder="Password" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalDepartment">Department</label> <input type="text" id="modalDepartment" class="form-input" value="B.Sc.IT - III Semester" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalPhone">Phone</label> <input type="tel" id="modalPhone" class="form-input" placeholder="Phone Number" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalAddress">Address</label> <input type="text" id="modalAddress" class="form-input" placeholder="Address" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalAttendance">Attendance %</label> <input type="number" id="modalAttendance" class="form-input" min="0" max="100" value="85" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalCGPA">CGPA</label> <input type="number" id="modalCGPA" class="form-input" min="0" max="10" step="0.01" value="8.5" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalFeesPaid">Fees Paid</label> <input type="number" id="modalFeesPaid" class="form-input" min="0" value="50000" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalFeesTotal">Total Fees</label> <input type="number" id="modalFeesTotal" class="form-input" min="0" value="75000" required>
        </div>
        <div class="form-group"><label class="form-label" for="modalBooks">Books Borrowed</label> <input type="number" id="modalBooks" class="form-input" min="0" value="3" required>
        </div>
       </div><button type="submit" class="save-btn" id="saveStudentBtn">Save Student</button>
      </form>
     </div>
    </div>
   </div>
   
<script>
// LOCAL dataSdk shim ‚Äî no network, localStorage persistence
(function(){
  function storageKeyForType(type){
    return 'sms_cache_' + (type || 'misc') + 's';
  }
  function readStore(type){
    try{
      const raw = localStorage.getItem(storageKeyForType(type));
      return raw ? JSON.parse(raw) : [];
    }catch(e){ console.warn('readStore parse failed', e); return []; }
  }
  function writeStore(type, arr){
    try{ localStorage.setItem(storageKeyForType(type), JSON.stringify(arr)); }catch(e){ console.warn('writeStore failed', e); }
  }
  function ensureId(record){
    if(record.__backendId) return record.__backendId;
    if(record.id) return record.id;
    const id = 'local_' + Date.now().toString() + '_' + Math.random().toString(36).slice(2,7);
    record.__backendId = id;
    return id;
  }
  window.dataSdk = window.dataSdk || {};
  window.dataSdk.create = async function(record){
    try{
      const type = record && record.type ? record.type : (record && record.roll_number ? 'student' : (record && record.teacher_id ? 'teacher' : 'misc'));
      const store = readStore(type);
      const rec = Object.assign({}, record);
      ensureId(rec);
      // if id present and unique ensure not duplicate
      store.push(rec);
      writeStore(type, store);
      return { isOk: true, id: rec.__backendId || rec.id };
    }catch(e){ console.warn('dataSdk.create error', e); return { isOk:false }; }
  };
  window.dataSdk.update = async function(backendId, record){
    try{
      // find type from record.type or fallback to student/teacher/payment/attendance by checking record fields
      const type = record && record.type ? record.type : (record && record.roll_number ? 'student' : (record && record.teacher_id ? 'teacher' : (record && record.amount ? 'fee_payment' : (record && record.date && record.student_id ? 'attendance' : 'misc'))));
      const store = readStore(type);
      const idKey = '__backendId';
      const idToFind = backendId || (record && (record.__backendId || record.id));
      const idx = store.findIndex(r => r[idKey] === idToFind || r.id === idToFind);
      if(idx !== -1){
        store[idx] = Object.assign({}, store[idx], record);
        writeStore(type, store);
        return { isOk: true };
      } else {
        // if not found, push as new
        const rec = Object.assign({}, record);
        ensureId(rec);
        store.push(rec);
        writeStore(type, store);
        return { isOk: true, id: rec.__backendId || rec.id };
      }
    }catch(e){ console.warn('dataSdk.update error', e); return { isOk:false }; }
  };
  window.dataSdk.delete = async function(backendIdOrRecord){
    try{
      let type = null;
      let id = null;
      if(typeof backendIdOrRecord === 'string') id = backendIdOrRecord;
      else if(typeof backendIdOrRecord === 'object'){ id = backendIdOrRecord.__backendId || backendIdOrRecord.id; type = backendIdOrRecord.type; }
      // if type not provided, try common types
      const typesToCheck = type ? [type] : ['student','teacher','attendance','fee_payment','event','message','misc'];
      for(const t of typesToCheck){
        const store = readStore(t);
        const idx = store.findIndex(r => r.__backendId === id || r.id === id);
        if(idx !== -1){
          store.splice(idx,1);
          writeStore(t, store);
          return { isOk: true };
        }
      }
      return { isOk: true };
    }catch(e){ console.warn('dataSdk.delete error', e); return { isOk:false }; }
  };
  // expose helper to read all types (used by app to initialize)
  window.dataSdk.readAll = function(){
    const types = ['student','teacher','attendance','fee_payment','event','message','misc'];
    const out = {};
    types.forEach(t => out[t+'s'] = readStore(t));
    return out;
  };
  window.dataSdk.init = async function(dataHandler) {
    const allData = window.dataSdk.readAll();
    if (dataHandler && dataHandler.onDataChanged) {
      dataHandler.onDataChanged(allData);
    }
    return { isOk: true };
  };
})();
window.elementSdk = {
  init: async function(config) {
    if (config.onConfigChange) {
      config.onConfigChange(config.defaultConfig);
    }
    return { isOk: true };
  }
};
</script>
<script>
    // Global state
    let currentUser = null;
    let allStudents = [];
    let allTeachers = [];
    let currentEditingStudent = null;
    let currentEditingTeacher = null;

    // Default config
    const defaultConfig = {
      website_title: "SMS (Students Management System) 6.0 - Advanced Edition",
      department_name: "B.Sc.IT - III Semester",
      college_name: "College of Technology - Advanced Campus"
    };

    // Global state for events and messages
    let allEvents = [];
    let allMessages = [];
    let allFeePayments = [];
    let allAttendance = [];

    // Data handler for SDK
    const dataHandler = {
      onDataChanged(data) {
        allStudents = data.filter(record => record.type === 'student');
        allTeachers = data.filter(record => record.type === 'teacher');
        allEvents = data.filter(record => record.type === 'event');
        allMessages = data.filter(record => record.type === 'message');
        allFeePayments = data.filter(record => record.type === 'fee_payment');
        allAttendance = data.filter(record => record.type === 'attendance');
        
        if (currentUser) {
          updateDashboard();
        }
      }
    };

    // Initialize SDK
    async function initializeApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Failed to initialize data SDK");
        return;
      }

      // Initialize Element SDK
      await window.elementSdk.init({
        defaultConfig: defaultConfig,
        onConfigChange: async (config) => {
          const titleElement = document.getElementById('websiteTitle');
          if (titleElement) {
            titleElement.textContent = config.website_title || defaultConfig.website_title;
          }
        },
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["website_title", config.website_title || defaultConfig.website_title],
          ["department_name", config.department_name || defaultConfig.department_name],
          ["college_name", config.college_name || defaultConfig.college_name]
        ])
      });

      // Initialize empty system
      await initializeEmptySystem();

      hideLoading();
    }

    // Initialize empty system - no default data
    async function initializeEmptySystem() {
      // System starts completely empty
      // All data will be added dynamically by admins and teachers
      console.log('SMS 6.0 initialized with empty database - ready for dynamic data entry');
    }

    // Navigation functions
    function showHome() {
      document.getElementById('homePage').style.display = 'block';
      document.getElementById('studentLoginPage').style.display = 'none';
      document.getElementById('teacherLoginPage').style.display = 'none';
      document.getElementById('adminLoginPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'none';
    }

    function showStudentLogin() {
      document.getElementById('homePage').style.display = 'none';
      document.getElementById('studentLoginPage').style.display = 'block';
      document.getElementById('studentLoginError').style.display = 'none';
    }

    function showTeacherLogin() {
      document.getElementById('homePage').style.display = 'none';
      document.getElementById('teacherLoginPage').style.display = 'block';
      document.getElementById('teacherLoginError').style.display = 'none';
    }

    function showAdminLogin() {
      document.getElementById('homePage').style.display = 'none';
      document.getElementById('adminLoginPage').style.display = 'block';
      document.getElementById('adminLoginError').style.display = 'none';
    }

    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    // Login handlers
    async function handleStudentLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('studentEmail').value.toLowerCase();
      const password = document.getElementById('studentPassword').value;
      const errorDiv = document.getElementById('studentLoginError');
      const loginBtn = document.getElementById('studentLoginBtn');
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      
      // Find student
      const student = allStudents.find(s => 
        s.email.toLowerCase() === email && s.password === password
      );
      
      if (student) {
        currentUser = { ...student, role: 'student' };
        document.getElementById('studentLoginPage').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex';
        document.getElementById('dashboard').classList.add('active');
        updateDashboard();
      } else {
        errorDiv.textContent = 'Invalid email or password. Please enter valid credentials.';
        errorDiv.style.display = 'block';
      }
      
      loginBtn.disabled = false;
      loginBtn.textContent = 'Login';
    }

    async function handleAdminLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('adminEmail').value.toLowerCase();
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('adminLoginError');
      const loginBtn = document.getElementById('adminLoginBtn');
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      
      // Check admin credentials
      if (email === 'admin@xxx.com' && password === 'admin123') {
        currentUser = { 
          name: 'Administrator',
          email: email,
          role: 'admin'
        };
        document.getElementById('adminLoginPage').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex';
        document.getElementById('dashboard').classList.add('active');
        updateDashboard();
      } else {
        errorDiv.textContent = 'Invalid email or password. Please enter valid credentials.';
        errorDiv.style.display = 'block';
      }
      
      loginBtn.disabled = false;
      loginBtn.textContent = 'Login';
    }

    async function handleTeacherLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('teacherEmail').value.toLowerCase();
      const password = document.getElementById('teacherPassword').value;
      const errorDiv = document.getElementById('teacherLoginError');
      const loginBtn = document.getElementById('teacherLoginBtn');
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      
      // Find teacher
      const teacher = allTeachers.find(t => 
        t.email.toLowerCase() === email && t.password === password
      );
      
      if (teacher) {
        currentUser = { ...teacher, role: 'teacher' };
        document.getElementById('teacherLoginPage').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex';
        document.getElementById('dashboard').classList.add('active');
        updateDashboard();
      } else {
        errorDiv.textContent = 'Invalid email or password. Please enter valid credentials.';
        errorDiv.style.display = 'block';
      }
      
      loginBtn.disabled = false;
      loginBtn.textContent = 'Login';
    }

    function logout() {
      currentUser = null;
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('dashboard').classList.remove('active');
      showHome();
      document.getElementById('studentEmail').value = '';
      document.getElementById('studentPassword').value = '';
      document.getElementById('teacherEmail').value = '';
      document.getElementById('teacherPassword').value = '';
      document.getElementById('adminEmail').value = '';
      document.getElementById('adminPassword').value = '';
    }

    // Dashboard functions
    function updateDashboard() {
      // Update user info
      document.getElementById('userName').textContent = currentUser.name;
      const roleText = currentUser.role === 'admin' ? 'Administrator' : 
                      currentUser.role === 'teacher' ? 'Teacher' : 'Student';
      document.getElementById('userRole').textContent = roleText;
      
      const avatarIcon = currentUser.role === 'admin' ? 'üë®‚Äçüíº' : 
                        currentUser.role === 'teacher' ? 'üë©‚Äçüè´' : 'üë®‚Äçüéì';
      document.getElementById('userAvatar').textContent = avatarIcon;
      
      // Show/hide role-based features
      const isAdmin = currentUser.role === 'admin';
      const isTeacher = currentUser.role === 'teacher';
      const isStudent = currentUser.role === 'student';
      
      // Student management buttons
      document.getElementById('addStudentBtn').style.display = (isAdmin || isTeacher) ? 'block' : 'none';
      document.getElementById('studentActionsHeader').style.display = (isAdmin || isTeacher) ? 'table-cell' : 'none';
      
      // Teacher management (admin only) - but keep tab visible, just disable functionality
      document.getElementById('addTeacherBtn').style.display = isAdmin ? 'block' : 'none';
      document.getElementById('teacherActionsHeader').style.display = isAdmin ? 'table-cell' : 'none';
      
      // Update overview
      updateOverview();
      updateStudentsTable();
      updateTeachersTable();
      updateAllTabs();
    }

    function updateOverview() {
      const statsGrid = document.getElementById('statsGrid');
      const studentProfile = document.getElementById('studentProfile');
      
      if (currentUser.role === 'admin' || currentUser.role === 'teacher') {
        studentProfile.style.display = 'none';
        statsGrid.style.display = 'grid';
        
        const totalStudents = allStudents.length;
        const totalTeachers = allTeachers.length;
        const avgAttendance = allStudents.length > 0 
          ? (allStudents.reduce((sum, s) => sum + s.attendance_percentage, 0) / totalStudents).toFixed(1)
          : 0;
        const avgCGPA = allStudents.length > 0
          ? (allStudents.reduce((sum, s) => sum + s.cgpa, 0) / totalStudents).toFixed(2)
          : 0;
        const totalFees = allStudents.reduce((sum, s) => sum + s.fees_paid, 0);
        
        let statsHTML = `
          <div class="stat-card">
            <div class="stat-icon">üë®‚Äçüéì</div>
            <div class="stat-value">${totalStudents}</div>
            <div class="stat-label">Total Students</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üïí</div>
            <div class="stat-value">${avgAttendance}%</div>
            <div class="stat-label">Avg Attendance</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìà</div>
            <div class="stat-value">${avgCGPA}</div>
            <div class="stat-label">Avg CGPA</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-value">‚Çπ${totalFees.toLocaleString()}</div>
            <div class="stat-label">Total Fees Collected</div>
          </div>
        `;
        
        if (currentUser.role === 'admin') {
          statsHTML += `
            <div class="stat-card">
              <div class="stat-icon">üë©‚Äçüè´</div>
              <div class="stat-value">${totalTeachers}</div>
              <div class="stat-label">Total Teachers</div>
            </div>
          `;
        }
        
        // Add welcome message for empty system
        if (totalStudents === 0 && totalTeachers === 0) {
          statsHTML += `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; margin-top: 20px;">
              <div style="font-size: 48px; margin-bottom: 20px;">üéì</div>
              <h3 style="margin-bottom: 15px;">Welcome to SMS 6.0!</h3>
              <p style="opacity: 0.9;">Your Student Management System is ready. Start by adding students and teachers to begin managing your institution.</p>
            </div>
          `;
        }
        
        statsGrid.innerHTML = statsHTML;
      } else {
        statsGrid.style.display = 'none';
        studentProfile.style.display = 'block';
        
        document.getElementById('profileName').textContent = currentUser.name;
        document.getElementById('profileRoll').textContent = currentUser.roll_number;
        document.getElementById('profileEmail').textContent = currentUser.email;
        document.getElementById('profileDept').textContent = currentUser.department;
        document.getElementById('profileAttendance').textContent = currentUser.attendance_percentage + '%';
        document.getElementById('profileCGPA').textContent = currentUser.cgpa;
        document.getElementById('profileAssignments').textContent = 
          `${currentUser.assignments_completed}/${currentUser.assignments_total}`;
      }
    }

    function updateStudentsTable() {
      const tbody = document.getElementById('studentsTableBody');
      const canEdit = currentUser.role === 'admin' || currentUser.role === 'teacher';
      
      const studentsToShow = canEdit ? allStudents : [currentUser];
      
      if (studentsToShow.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="${canEdit ? '6' : '5'}" style="text-align: center; padding: 40px; color: #666;">
              <div style="font-size: 48px; margin-bottom: 20px;">üë®‚Äçüéì</div>
              <h3>No Students Found</h3>
              <p>${canEdit ? 'Click "Add Student" to add the first student to the system.' : 'No student data available.'}</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = studentsToShow.map(student => `
        <tr>
          <td>${student.roll_number}</td>
          <td>${student.name}</td>
          <td>${student.email}</td>
          <td>${student.department}</td>
          <td>${student.phone || 'N/A'}</td>
          ${canEdit ? `
            <td>
              <button class="action-btn edit-btn" onclick="editStudent('${student.__backendId}')">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteStudent('${student.__backendId}')">Delete</button>
            </td>
          ` : ''}
        </tr>
      `).join('');
    }

    function updateTeachersTable() {
      const tbody = document.getElementById('teachersTableBody');
      const isAdmin = currentUser.role === 'admin';
      
      if (!isAdmin) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
              <div style="font-size: 48px; margin-bottom: 20px;">üîí</div>
              <h3>Access Restricted</h3>
              <p>Only administrators can view teacher information.</p>
            </td>
          </tr>
        `;
        return;
      }
      
      if (allTeachers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
              <div style="font-size: 48px; margin-bottom: 20px;">üë©‚Äçüè´</div>
              <h3>No Teachers Found</h3>
              <p>Click "Add Teacher" to add the first teacher to the system.</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = allTeachers.map(teacher => `
        <tr>
          <td>${teacher.teacher_id}</td>
          <td>${teacher.name}</td>
          <td>${teacher.email}</td>
          <td>${teacher.subject}</td>
          <td>${teacher.phone || 'N/A'}</td>
          <td>
            <button class="action-btn edit-btn" onclick="editTeacher('${teacher.__backendId}')">Edit</button>
            <button class="action-btn delete-btn" onclick="deleteTeacher('${teacher.__backendId}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function updateAllTabs() {
      const canViewAll = currentUser.role === 'admin' || currentUser.role === 'teacher';
      const students = canViewAll ? allStudents : [currentUser];
      
      // Attendance
      updateAttendanceTab();
      
      // Results
      if (students.length === 0) {
        document.getElementById('resultsContent').innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 20px;">üìà</div>
            <h3>No Results Available</h3>
            <p>Results will appear here once students are added to the system.</p>
          </div>
        `;
      } else {
        document.getElementById('resultsContent').innerHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Roll No</th>
                  <th>Name</th>
                  <th>CGPA</th>
                  <th>Grade</th>
                </tr>
              </thead>
              <tbody>
                ${students.map(s => {
                  const grade = s.cgpa >= 9 ? 'A+' : s.cgpa >= 8 ? 'A' : s.cgpa >= 7 ? 'B+' : s.cgpa >= 6 ? 'B' : 'C';
                  return `
                    <tr>
                      <td>${s.roll_number}</td>
                      <td>${s.name}</td>
                      <td>${s.cgpa}</td>
                      <td style="font-weight: bold; color: #667eea;">${grade}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      
      // Fees
      updateFeesTab();
      
      // Library
      if (students.length === 0) {
        document.getElementById('libraryContent').innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 20px;">üìö</div>
            <h3>No Library Records</h3>
            <p>Library records will appear here once students are added to the system.</p>
          </div>
        `;
      } else {
        document.getElementById('libraryContent').innerHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Roll No</th>
                  <th>Name</th>
                  <th>Books Borrowed</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${students.map(s => `
                  <tr>
                    <td>${s.roll_number}</td>
                    <td>${s.name}</td>
                    <td>${s.books_borrowed}</td>
                    <td style="color: ${s.books_borrowed <= 5 ? '#43e97b' : '#ff6b6b'}; font-weight: bold;">
                      ${s.books_borrowed <= 5 ? '‚úì Within Limit' : '‚ö† Exceeded'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      
      // Assignments
      if (students.length === 0) {
        document.getElementById('assignmentsContent').innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 20px;">üìù</div>
            <h3>No Assignments</h3>
            <p>Assignment records will appear here once students are added to the system.</p>
          </div>
        `;
      } else {
        document.getElementById('assignmentsContent').innerHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Roll No</th>
                  <th>Name</th>
                  <th>Completed</th>
                  <th>Total</th>
                  <th>Percentage</th>
                </tr>
              </thead>
              <tbody>
                ${students.map(s => {
                  const percentage = s.assignments_total > 0 
                    ? ((s.assignments_completed / s.assignments_total) * 100).toFixed(0)
                    : 0;
                  return `
                    <tr>
                      <td>${s.roll_number}</td>
                      <td>${s.name}</td>
                      <td>${s.assignments_completed}</td>
                      <td>${s.assignments_total}</td>
                      <td style="color: ${percentage >= 80 ? '#43e97b' : '#ff6b6b'}; font-weight: bold;">
                        ${percentage}%
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      
      // Events
      updateEventsTab();
      
      // Messages
      updateMessagesTab();
    }

    // Tab navigation
    function showTab(tabName) {
      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      
      // Find and activate the clicked nav item
      const clickedItem = Array.from(document.querySelectorAll('.nav-item')).find(item => {
        return item.onclick && item.onclick.toString().includes(`showTab('${tabName}')`);
      });
      if (clickedItem) {
        clickedItem.classList.add('active');
      }
      
      // Update content header
      const tabInfo = {
        overview: { icon: 'üìä', title: 'Dashboard Overview' },
        students: { icon: 'üë®‚Äçüéì', title: 'Students Management' },
        teachers: { icon: 'üë©‚Äçüè´', title: 'Teachers Management' },
        attendance: { icon: 'üïí', title: 'Attendance Management' },
        results: { icon: 'üìà', title: 'Results & Grades' },
        fees: { icon: 'üí∞', title: 'Fee Management' },
        library: { icon: 'üìö', title: 'Library Records' },
        assignments: { icon: 'üìù', title: 'Assignments' },
        events: { icon: 'üìÖ', title: 'Events & Activities' },
        messages: { icon: 'üí¨', title: 'Messages' }
      };
      
      const info = tabInfo[tabName];
      if (info) {
        document.getElementById('contentIcon').textContent = info.icon;
        document.getElementById('contentTitle').textContent = info.title;
      }
      
      // Hide all tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
      });
      
      // Show selected tab content
      const selectedTab = document.getElementById(tabName + 'Tab');
      if (selectedTab) {
        selectedTab.classList.add('active');
        selectedTab.style.display = 'block';
      }
    }

    // Student CRUD operations
    function showAddStudentModal() {
      currentEditingStudent = null;
      document.getElementById('modalTitle').textContent = 'Add Student';
      document.getElementById('studentForm').reset();
      document.getElementById('modalDepartment').value = 'B.Sc.IT - III Semester';
      document.getElementById('modalError').style.display = 'none';
      document.getElementById('modalSuccess').style.display = 'none';
      document.getElementById('studentModal').style.display = 'block';
    }

    function editStudent(backendId) {
      const student = allStudents.find(s => s.__backendId === backendId);
      if (!student) return;
      
      currentEditingStudent = student;
      document.getElementById('modalTitle').textContent = 'Edit Student';
      document.getElementById('modalRollNumber').value = student.roll_number;
      document.getElementById('modalName').value = student.name;
      document.getElementById('modalEmail').value = student.email;
      document.getElementById('modalPassword').value = student.password;
      document.getElementById('modalDepartment').value = student.department;
      document.getElementById('modalPhone').value = student.phone || '';
      document.getElementById('modalAddress').value = student.address || '';
      document.getElementById('modalAttendance').value = student.attendance_percentage;
      document.getElementById('modalCGPA').value = student.cgpa;
      document.getElementById('modalFeesPaid').value = student.fees_paid;
      document.getElementById('modalFeesTotal').value = student.fees_total;
      document.getElementById('modalBooks').value = student.books_borrowed;
      document.getElementById('modalError').style.display = 'none';
      document.getElementById('modalSuccess').style.display = 'none';
      document.getElementById('studentModal').style.display = 'block';
    }

    async function deleteStudent(backendId) {
      const student = allStudents.find(s => s.__backendId === backendId);
      if (!student) return;
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 2000; text-align: center;';
      confirmDiv.innerHTML = `
        <h3 style="margin-bottom: 20px; color: #333;">Delete Student</h3>
        <p style="margin-bottom: 20px; color: #666;">Are you sure you want to delete ${student.name}?</p>
        <button onclick="confirmDelete('${backendId}')" style="padding: 10px 25px; background: #ff6b6b; color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px; font-weight: bold;">Delete</button>
        <button onclick="cancelDelete()" style="padding: 10px 25px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Cancel</button>
      `;
      
      const backdrop = document.createElement('div');
      backdrop.id = 'deleteBackdrop';
      backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;';
      backdrop.appendChild(confirmDiv);
      document.body.appendChild(backdrop);
    }

    async function confirmDelete(backendId) {
      const student = allStudents.find(s => s.__backendId === backendId);
      if (!student) return;
      
      const result = await window.dataSdk.delete(student);
      
      const backdrop = document.getElementById('deleteBackdrop');
      if (backdrop) backdrop.remove();
      
      if (!result.isOk) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #fee; color: #c33; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;';
        errorDiv.textContent = 'Failed to delete student';
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 3000);
      }
    }

    function cancelDelete() {
      const backdrop = document.getElementById('deleteBackdrop');
      if (backdrop) backdrop.remove();
    }

    function closeStudentModal() {
      document.getElementById('studentModal').style.display = 'none';
      currentEditingStudent = null;
    }

    async function handleStudentSubmit(event) {
      event.preventDefault();
      
      const saveBtn = document.getElementById('saveStudentBtn');
      const errorDiv = document.getElementById('modalError');
      const successDiv = document.getElementById('modalSuccess');
      
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      if (allStudents.length >= 999 && !currentEditingStudent) {
        errorDiv.textContent = 'Maximum limit of 999 students reached. Please delete some students first.';
        errorDiv.style.display = 'block';
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Student';
        return;
      }
      
      const studentData = {
        type: 'student',
        roll_number: document.getElementById('modalRollNumber').value,
        name: document.getElementById('modalName').value,
        email: document.getElementById('modalEmail').value.toLowerCase(),
        password: document.getElementById('modalPassword').value,
        department: document.getElementById('modalDepartment').value,
        semester: 'III Semester',
        phone: document.getElementById('modalPhone').value,
        address: document.getElementById('modalAddress').value,
        attendance_percentage: parseFloat(document.getElementById('modalAttendance').value),
        cgpa: parseFloat(document.getElementById('modalCGPA').value),
        fees_paid: parseFloat(document.getElementById('modalFeesPaid').value),
        fees_total: parseFloat(document.getElementById('modalFeesTotal').value),
        books_borrowed: parseInt(document.getElementById('modalBooks').value),
        assignments_completed: 8,
        assignments_total: 10,
        role: 'student',
        timestamp: new Date().toISOString()
      };
      
      let result;
      if (currentEditingStudent) {
        result = await window.dataSdk.update({
          ...studentData,
          __backendId: currentEditingStudent.__backendId,
          id: currentEditingStudent.id
        });
      } else {
        result = await window.dataSdk.create({
          ...studentData,
          id: Date.now().toString()
        });
      }
      
      if (result.isOk) {
        successDiv.textContent = currentEditingStudent ? 'Student updated successfully!' : 'Student added successfully!';
        successDiv.style.display = 'block';
        setTimeout(() => {
          closeStudentModal();
        }, 1500);
      } else {
        errorDiv.textContent = 'Failed to save student. Please try again.';
        errorDiv.style.display = 'block';
      }
      
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Student';
    }

    // Loading functions
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    // Teacher CRUD operations
    function showAddTeacherModal() {
      currentEditingTeacher = null;
      document.getElementById('teacherModalTitle').textContent = 'Add Teacher';
      document.getElementById('teacherForm').reset();
      document.getElementById('teacherModalDepartment').value = 'B.Sc.IT';
      document.getElementById('teacherModalError').style.display = 'none';
      document.getElementById('teacherModalSuccess').style.display = 'none';
      document.getElementById('teacherModal').style.display = 'block';
    }

    function editTeacher(backendId) {
      const teacher = allTeachers.find(t => t.__backendId === backendId);
      if (!teacher) return;
      
      currentEditingTeacher = teacher;
      document.getElementById('teacherModalTitle').textContent = 'Edit Teacher';
      document.getElementById('teacherModalId').value = teacher.teacher_id;
      document.getElementById('teacherModalName').value = teacher.name;
      document.getElementById('teacherModalEmail').value = teacher.email;
      document.getElementById('teacherModalPassword').value = teacher.password;
      document.getElementById('teacherModalSubject').value = teacher.subject;
      document.getElementById('teacherModalPhone').value = teacher.phone || '';
      document.getElementById('teacherModalDepartment').value = teacher.department;
      document.getElementById('teacherModalExperience').value = teacher.experience || 5;
      document.getElementById('teacherModalError').style.display = 'none';
      document.getElementById('teacherModalSuccess').style.display = 'none';
      document.getElementById('teacherModal').style.display = 'block';
    }

    async function deleteTeacher(backendId) {
      const teacher = allTeachers.find(t => t.__backendId === backendId);
      if (!teacher) return;
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 2000; text-align: center;';
      confirmDiv.innerHTML = `
        <h3 style="margin-bottom: 20px; color: #333;">Delete Teacher</h3>
        <p style="margin-bottom: 20px; color: #666;">Are you sure you want to delete ${teacher.name}?</p>
        <button onclick="confirmDeleteTeacher('${backendId}')" style="padding: 10px 25px; background: #ff6b6b; color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px; font-weight: bold;">Delete</button>
        <button onclick="cancelDelete()" style="padding: 10px 25px; background: #e0e0e0; color: #333; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Cancel</button>
      `;
      
      const backdrop = document.createElement('div');
      backdrop.id = 'deleteBackdrop';
      backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;';
      backdrop.appendChild(confirmDiv);
      document.body.appendChild(backdrop);
    }

    async function confirmDeleteTeacher(backendId) {
      const teacher = allTeachers.find(t => t.__backendId === backendId);
      if (!teacher) return;
      
      const result = await window.dataSdk.delete(teacher);
      
      const backdrop = document.getElementById('deleteBackdrop');
      if (backdrop) backdrop.remove();
      
      if (!result.isOk) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #fee; color: #c33; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;';
        errorDiv.textContent = 'Failed to delete teacher';
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 3000);
      }
    }

    function closeTeacherModal() {
      document.getElementById('teacherModal').style.display = 'none';
      currentEditingTeacher = null;
    }

    async function handleTeacherSubmit(event) {
      event.preventDefault();
      
      const saveBtn = document.getElementById('saveTeacherBtn');
      const errorDiv = document.getElementById('teacherModalError');
      const successDiv = document.getElementById('teacherModalSuccess');
      
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      if (allTeachers.length >= 999 && !currentEditingTeacher) {
        errorDiv.textContent = 'Maximum limit of 999 teachers reached. Please delete some teachers first.';
        errorDiv.style.display = 'block';
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Teacher';
        return;
      }
      
      const teacherData = {
        type: 'teacher',
        teacher_id: document.getElementById('teacherModalId').value,
        name: document.getElementById('teacherModalName').value,
        email: document.getElementById('teacherModalEmail').value.toLowerCase(),
        password: document.getElementById('teacherModalPassword').value,
        subject: document.getElementById('teacherModalSubject').value,
        phone: document.getElementById('teacherModalPhone').value,
        department: document.getElementById('teacherModalDepartment').value,
        experience: parseInt(document.getElementById('teacherModalExperience').value),
        attendance_percentage: 95,
        role: 'teacher',
        timestamp: new Date().toISOString()
      };
      
      let result;
      if (currentEditingTeacher) {
        result = await window.dataSdk.update({
          ...teacherData,
          __backendId: currentEditingTeacher.__backendId,
          id: currentEditingTeacher.id
        });
      } else {
        result = await window.dataSdk.create({
          ...teacherData,
          id: Date.now().toString()
        });
      }
      
      if (result.isOk) {
        successDiv.textContent = currentEditingTeacher ? 'Teacher updated successfully!' : 'Teacher added successfully!';
        successDiv.style.display = 'block';
        setTimeout(() => {
          closeTeacherModal();
        }, 1500);
      } else {
        errorDiv.textContent = 'Failed to save teacher. Please try again.';
        errorDiv.style.display = 'block';
      }
      
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Teacher';
    }

    // Events Management
    function updateEventsTab() {
      const eventsContent = document.getElementById('eventsContent');
      const canSendEvents = currentUser.role === 'admin' || currentUser.role === 'teacher';
      
      let eventsHTML = '';
      
      if (canSendEvents) {
        eventsHTML += `
          <div style="margin-bottom: 30px;">
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
              <button class="add-btn" onclick="showEventModal('students')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                üìÖ Send Event to Students
              </button>
              ${currentUser.role === 'admin' ? `
                <button class="add-btn" onclick="showEventModal('teachers')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                  üìÖ Send Event to Teachers
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }
      
      // Filter events based on user role
      let visibleEvents = allEvents.filter(event => {
        if (currentUser.role === 'student') {
          return event.event_target === 'students';
        } else if (currentUser.role === 'teacher') {
          return event.event_target === 'students' || event.event_target === 'teachers';
        } else {
          return true; // Admin sees all
        }
      });

      // Sort events by timestamp (newest first)
      visibleEvents.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      eventsHTML += `
        <div class="events-list">
          ${visibleEvents.length === 0 ? `
            <div style="text-align: center; padding: 40px; color: #666;">
              <div style="font-size: 48px; margin-bottom: 20px;">üìÖ</div>
              <h3>No Events Yet</h3>
              <p>Events will appear here when they are created.</p>
            </div>
          ` : visibleEvents.map((event, index) => {
            const colors = [
              'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
              'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
              'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
            ];
            const bgColor = colors[index % colors.length];
            const eventDate = new Date(event.event_date).toLocaleDateString();
            const senderRole = event.event_sender === 'admin' ? 'Admin' : 'Teacher';
            
            return `
              <div class="event-card" style="background: ${bgColor}; color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                  <h3 style="margin: 0; font-size: 24px;">üìÖ ${event.event_title}</h3>
                  <span style="background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 12px;">
                    For ${event.event_target === 'students' ? 'Students' : 'Teachers'}
                  </span>
                </div>
                <p style="margin-bottom: 10px; opacity: 0.9;">${event.event_description}</p>
                <div style="display: flex; gap: 20px; font-size: 14px; opacity: 0.8; flex-wrap: wrap;">
                  <span>üìÖ ${eventDate}</span>
                  <span>üìç ${event.event_venue}</span>
                  <span>üë§ ${senderRole}</span>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      eventsContent.innerHTML = eventsHTML;
    }

    function updateMessagesTab() {
      const messagesContent = document.getElementById('messagesContent');
      const canSendMessages = currentUser.role === 'admin' || currentUser.role === 'teacher';
      
      let messagesHTML = '';
      
      if (canSendMessages) {
        messagesHTML += `
          <div style="margin-bottom: 30px;">
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
              <button class="add-btn" onclick="showMessageModal('students')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                üí¨ Send Message to Students
              </button>
              ${currentUser.role === 'admin' ? `
                <button class="add-btn" onclick="showMessageModal('teachers')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                  üí¨ Send Message to Teachers
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }
      
      // Filter messages based on user role
      let visibleMessages = allMessages.filter(message => {
        if (currentUser.role === 'student') {
          return message.message_target === 'students';
        } else if (currentUser.role === 'teacher') {
          return message.message_target === 'students' || message.message_target === 'teachers';
        } else {
          return true; // Admin sees all
        }
      });

      // Sort messages by timestamp (newest first)
      visibleMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      messagesHTML += `
        <div class="messages-list">
          ${visibleMessages.length === 0 ? `
            <div style="text-align: center; padding: 40px; color: #666;">
              <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
              <h3>No Messages Yet</h3>
              <p>Messages will appear here when they are sent.</p>
            </div>
          ` : visibleMessages.map((message, index) => {
            const colors = ['#667eea', '#f5576c', '#43e97b', '#4facfe', '#f093fb'];
            const borderColor = colors[index % colors.length];
            const bgColor = colors[index % colors.length];
            const messageDate = new Date(message.timestamp).toLocaleDateString();
            const timeAgo = getTimeAgo(new Date(message.timestamp));
            const senderRole = message.message_sender === 'admin' ? 'Admin' : 'Teacher';
            
            return `
              <div class="message-card" style="background: white; border: 1px solid #e0e0e0; border-left: 4px solid ${borderColor}; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                  <div style="font-weight: bold; color: #333; font-size: 16px;">üí¨ ${message.message_title}</div>
                  <span style="background: ${bgColor}; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">
                    For ${message.message_target === 'students' ? 'Students' : 'Teachers'}
                  </span>
                </div>
                <div style="color: #666; font-size: 14px; margin-bottom: 10px;">From: ${senderRole} ‚Ä¢ ${timeAgo}</div>
                <p style="color: #333; line-height: 1.5;">${message.message_content}</p>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      messagesContent.innerHTML = messagesHTML;
    }

    // Helper function to get time ago
    function getTimeAgo(date) {
      const now = new Date();
      const diffInMs = now - date;
      const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
      const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
      const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
      
      if (diffInMinutes < 60) {
        return diffInMinutes <= 1 ? 'Just now' : `${diffInMinutes} minutes ago`;
      } else if (diffInHours < 24) {
        return diffInHours === 1 ? '1 hour ago' : `${diffInHours} hours ago`;
      } else {
        return diffInDays === 1 ? '1 day ago' : `${diffInDays} days ago`;
      }
    }

    function showEventModal(target) {
      // Create event modal dynamically
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">üìÖ Send Event to ${target === 'students' ? 'Students' : 'Teachers'}</h2>
            <span class="close-btn" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <form onsubmit="handleEventSubmit(event, '${target}')">
            <div class="form-group">
              <label class="form-label">Event Title</label>
              <input type="text" class="form-input" id="eventTitle" placeholder="Enter event title" required>
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea class="form-input" id="eventDescription" rows="4" placeholder="Enter event description" required></textarea>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="eventDate" required>
              </div>
              <div class="form-group">
                <label class="form-label">Venue</label>
                <input type="text" class="form-input" id="eventVenue" placeholder="Enter venue" required>
              </div>
            </div>
            <button type="submit" class="save-btn">Send Event</button>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function showMessageModal(target) {
      // Create message modal dynamically
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">üí¨ Send Message to ${target === 'students' ? 'Students' : 'Teachers'}</h2>
            <span class="close-btn" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <form onsubmit="handleMessageSubmit(event, '${target}')">
            <div class="form-group">
              <label class="form-label">Message Title</label>
              <input type="text" class="form-input" id="messageTitle" placeholder="Enter message title" required>
            </div>
            <div class="form-group">
              <label class="form-label">Message Content</label>
              <textarea class="form-input" id="messageContent" rows="6" placeholder="Enter your message" required></textarea>
            </div>
            <button type="submit" class="save-btn">Send Message</button>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function handleEventSubmit(event, target) {
      event.preventDefault();
      
      const eventData = {
        type: 'event',
        event_title: document.getElementById('eventTitle').value,
        event_description: document.getElementById('eventDescription').value,
        event_date: document.getElementById('eventDate').value,
        event_venue: document.getElementById('eventVenue').value,
        event_target: target,
        event_sender: currentUser.role,
        timestamp: new Date().toISOString(),
        id: Date.now().toString()
      };
      
      const result = await window.dataSdk.create(eventData);
      
      if (result.isOk) {
        event.target.closest('.modal').remove();
        updateEventsTab();
        
        // Show success message
        const successDiv = document.createElement('div');
        successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4edda; color: #155724; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;';
        successDiv.textContent = 'Event sent successfully!';
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
      }
    }

    async function handleMessageSubmit(event, target) {
      event.preventDefault();
      
      const messageData = {
        type: 'message',
        message_title: document.getElementById('messageTitle').value,
        message_content: document.getElementById('messageContent').value,
        message_target: target,
        message_sender: currentUser.role,
        message_date: new Date().toISOString(),
        timestamp: new Date().toISOString(),
        id: Date.now().toString()
      };
      
      const result = await window.dataSdk.create(messageData);
      
      if (result.isOk) {
        event.target.closest('.modal').remove();
        updateMessagesTab();
        
        // Show success message
        const successDiv = document.createElement('div');
        successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4edda; color: #155724; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;';
        successDiv.textContent = 'Message sent successfully!';
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
      }
    }

    function updateAttendanceTab() {
      const attendanceContent = document.getElementById('attendanceContent');
      const canEdit = currentUser.role === 'admin' || currentUser.role === 'teacher';
      const students = canEdit ? allStudents : [currentUser];
      
      let attendanceHTML = '';
      
      if (canEdit && students.length > 0) {
        attendanceHTML += `
          <div style="margin-bottom: 30px;">
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
              <button class="add-btn" onclick="markAttendance()" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                ‚úì Mark Today's Attendance
              </button>
              <button class="add-btn" onclick="generateAttendanceReport()" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                üìä Generate Report
              </button>
            </div>
          </div>
        `;
      }
      
      if (students.length === 0) {
        attendanceHTML += `
          <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 20px;">üïí</div>
            <h3>No Attendance Records</h3>
            <p>Attendance records will appear here once students are added to the system.</p>
          </div>
        `;
      } else {
        attendanceHTML += `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Roll No</th>
                  <th>Name</th>
                  <th>Attendance %</th>
                  <th>Status</th>
                  <th>Last Updated</th>
                  ${canEdit ? '<th>Actions</th>' : ''}
                </tr>
              </thead>
              <tbody>
                ${students.map(s => `
                  <tr>
                    <td>${s.roll_number}</td>
                    <td>${s.name}</td>
                    <td>
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 100px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                          <div style="width: ${s.attendance_percentage}%; height: 100%; background: ${s.attendance_percentage >= 75 ? '#43e97b' : '#ff6b6b'}; transition: all 0.3s ease;"></div>
                        </div>
                        <span style="font-weight: bold;">${s.attendance_percentage}%</span>
                      </div>
                    </td>
                    <td>
                      <span style="color: ${s.attendance_percentage >= 75 ? '#43e97b' : '#ff6b6b'}; font-weight: bold; padding: 5px 12px; background: ${s.attendance_percentage >= 75 ? 'rgba(67, 233, 123, 0.1)' : 'rgba(255, 107, 107, 0.1)'}; border-radius: 20px; font-size: 12px;">
                        ${s.attendance_percentage >= 75 ? '‚úì Good' : '‚ö† Low'}
                      </span>
                    </td>
                    <td style="color: #666; font-size: 14px;">Today</td>
                    ${canEdit ? `
                      <td>
                        <button class="action-btn edit-btn" onclick="editAttendance('${s.__backendId}')" style="font-size: 12px; padding: 5px 10px;">Edit</button>
                      </td>
                    ` : ''}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      
      attendanceContent.innerHTML = attendanceHTML;
    }

    
    function markAttendance() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">‚úì Mark Today's Attendance</h2>
            <span class="close-btn" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <div style="max-height: 400px; overflow-y: auto; padding-bottom:10px;">
            <div style="margin-bottom: 20px;">
              <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button type="button" onclick="markAllPresent()" style="padding: 8px 12px; border-radius: 5px; cursor: pointer;">Mark All Present</button>
                <button type="button" onclick="markAllAbsent()" style="padding: 8px 12px; border-radius: 5px; cursor: pointer;">Mark All Absent</button>
              </div>
            </div>
            ${allStudents.map(student => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px;">
                <div>
                  <div style="font-weight: bold;">${student.name}</div>
                  <div style="font-size: 14px; color: #666;">${student.roll_number}</div>
                </div>
                <div style="display: flex; gap: 10px;">
                  <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="radio" name="attendance_${student.__backendId}" value="present" style="margin: 0;">
                    <span style="color: #43e97b; font-weight: bold;">Present</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="radio" name="attendance_${student.__backendId}" value="absent" style="margin: 0;">
                    <span style="color: #ff6b6b; font-weight: bold;">Absent</span>
                  </label>
                </div>
              </div>
            `).join('')}
          </div>
          <div style="text-align: right; margin-top: 10px;">
            <button class="save-btn" id="saveAttendanceBtn">Save Attendance</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // helper functions
      window.markAllPresent = function() {
        allStudents.forEach(s => {
          const el = modal.querySelector(`input[name="attendance_${s.__backendId}"][value="present"]`);
          if (el) el.checked = true;
        });
      };
      window.markAllAbsent = function() {
        allStudents.forEach(s => {
          const el = modal.querySelector(`input[name="attendance_${s.__backendId}"][value="absent"]`);
          if (el) el.checked = true;
        });
      };

      // save handler
      modal.querySelector('#saveAttendanceBtn').onclick = async function() {
        const today = new Date().toISOString().split('T')[0];
        const updates = [];

        for (const student of allStudents) {
          const sel = modal.querySelector(`input[name="attendance_${student.__backendId}"]:checked`);
          if (!sel) continue; // skip if not set
          const status = sel.value; // 'present' or 'absent'

          // create attendance record
          const attendanceRecord = {
            type: 'attendance',
            student_id: student.id,
            student_backend_id: student.__backendId,
            student_name: student.name,
            student_roll: student.roll_number,
            status: status,
            date: today,
            id: Date.now().toString() + '_' + Math.random().toString(36).slice(2,7),
            timestamp: new Date().toISOString()
          };

          try {
            const res = await window.dataSdk.create(attendanceRecord);
            // push to local array for immediate computation (use returned id if available)
            allAttendance.unshift(Object.assign({}, attendanceRecord, { __backendId: res && res.id ? res.id : attendanceRecord.id }));
          } catch (err) {
            console.error('Failed to create attendance record', err);
            // continue, we still try to update student locally
            allAttendance.unshift(attendanceRecord);
          }

          // recompute attendance percentage for this student from allAttendance
          const studentRecords = allAttendance.filter(a => a.student_id === student.id || a.student_backend_id === student.__backendId);
          // ensure unique dates (in case multiple records for same date) - use latest per date
          const byDate = {};
          for (const r of studentRecords) {
            byDate[r.date] = r;
          }
          const records = Object.values(byDate);
          const presentCount = records.filter(r => r.status === 'present').length;
          const totalCount = records.length || 1;
          const newAttendancePercent = Math.round((presentCount / totalCount) * 100);

          const updatedStudent = Object.assign({}, student, { attendance_percentage: newAttendancePercent });

          try {
            const updRes = await window.dataSdk.update(updatedStudent);
            // update local allStudents entry
            Object.assign(student, updatedStudent);
            updates.push(updatedStudent);
          } catch (err) {
            console.error('Failed to update student attendance', err);
            // still update locally to reflect in UI
            Object.assign(student, updatedStudent);
            updates.push(updatedStudent);
          }
        }

        // refresh UI
        updateStudentsTable();
        updateAttendanceTab();
        updateOverview();

        modal.remove();

        // success toast
        const successDiv = document.createElement('div');
        successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4edda; color: #155724; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;';
        successDiv.textContent = 'Attendance saved successfully!';
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
      };
    }
    function editAttendance(backendId) {
      const student = allStudents.find(s => s.__backendId === backendId);
      if (!student) return;
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Edit Attendance - ${student.name}</h2>
            <span class="close-btn" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <div class="form-group">
            <label class="form-label">Attendance Percentage</label>
            <input type="number" id="editAttendanceValue" class="form-input" min="0" max="100" value="${student.attendance_percentage}" required>
          </div>
          <button onclick="saveAttendanceEdit('${backendId}')" class="save-btn">Update Attendance</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveAttendanceEdit(backendId) {
      const student = allStudents.find(s => s.__backendId === backendId);
      if (!student) return;
      
      const newAttendance = parseFloat(document.getElementById('editAttendanceValue').value);
      
      const result = await window.dataSdk.update({
        ...student,
        attendance_percentage: newAttendance
      });
      
      if (result.isOk) {
        document.querySelector('.modal').remove();
        
        // Show success message
        const successDiv = document.createElement('div');
        successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4edda; color: #155724; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;';
        successDiv.textContent = 'Attendance updated successfully!';
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
      }
    }

    function generateAttendanceReport() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      
      const totalStudents = allStudents.length;
      const avgAttendance = totalStudents > 0 
        ? (allStudents.reduce((sum, s) => sum + s.attendance_percentage, 0) / totalStudents).toFixed(1)
        : 0;
      const goodAttendance = allStudents.filter(s => s.attendance_percentage >= 75).length;
      const lowAttendance = allStudents.filter(s => s.attendance_percentage < 75).length;
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">üìä Attendance Report</h2>
            <span class="close-btn" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <div style="margin-bottom: 30px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 32px; font-weight: bold;">${totalStudents}</div>
                <div>Total Students</div>
              </div>
              <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 32px; font-weight: bold;">${avgAttendance}%</div>
                <div>Average Attendance</div>
              </div>
              <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 32px; font-weight: bold;">${goodAttendance}</div>
                <div>Good Attendance (‚â•75%)</div>
              </div>
              <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                <div style="font-size: 32px; font-weight: bold;">${lowAttendance}</div>
                <div>Low Attendance (<75%)</div>
              </div>
            </div>
            
            <h3 style="margin-bottom: 15px; color: #333;">Students with Low Attendance</h3>
            <div style="max-height: 300px; overflow-y: auto;">
              ${allStudents.filter(s => s.attendance_percentage < 75).map(student => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: #fff5f5;">
                  <div>
                    <div style="font-weight: bold; color: #333;">${student.name}</div>
                    <div style="font-size: 14px; color: #666;">${student.roll_number}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 20px; font-weight: bold; color: #ff6b6b;">${student.attendance_percentage}%</div>
                    <div style="font-size: 12px; color: #999;">Needs Attention</div>
                  </div>
                </div>
              `).join('') || '<p style="text-align: center; color: #43e97b; font-weight: bold;">üéâ All students have good attendance!</p>'}
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Fees Management
    function updateFeesTab() {
      const feesContent = document.getElementById('feesContent');
      const canViewAll = currentUser.role === 'admin' || currentUser.role === 'teacher';
      const students = canViewAll ? allStudents : [currentUser];
      
      let feesHTML = '';
      
      if (students.length === 0) {
        feesHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 20px;">üí∞</div>
            <h3>No Fee Records</h3>
            <p>Fee records will appear here once students are added to the system.</p>
          </div>
        `;
      } else {
        feesHTML += `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Roll No</th>
                  <th>Name</th>
                  <th>Total Fees</th>
                  <th>Paid</th>
                  <th>Balance</th>
                  <th>Status</th>
                  ${currentUser.role === 'student' ? '<th>Actions</th>' : ''}
                </tr>
              </thead>
              <tbody>
                ${students.map(s => {
                  const balance = s.fees_total - s.fees_paid;
                  const isPaid = balance === 0;
                  return `
                    <tr>
                      <td>${s.roll_number}</td>
                      <td>${s.name}</td>
                      <td>‚Çπ${s.fees_total.toLocaleString()}</td>
                      <td>‚Çπ${s.fees_paid.toLocaleString()}</td>
                      <td>‚Çπ${balance.toLocaleString()}</td>
                      <td style="color: ${isPaid ? '#43e97b' : '#ff6b6b'}; font-weight: bold;">
                        ${isPaid ? '‚úì Paid' : '‚ö† Pending'}
                      </td>
                      ${currentUser.role === 'student' ? `
                        <td>
                          ${!isPaid ? `
                            <button class="action-btn" onclick="payFees('${s.__backendId}', ${balance})" style="background: #43e97b; color: white; margin-right: 5px;">
                              üí≥ Pay ‚Çπ${balance.toLocaleString()}
                            </button>
                          ` : ''}
                          ${s.fees_paid > 0 ? `
                            <button class="action-btn" onclick="downloadReceipt('${s.__backendId}')" style="background: #4facfe; color: white;">
                              üìÑ Download Receipt
                            </button>
                          ` : ''}
                        </td>
                      ` : ''}
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        // Add payment history for students
        if (currentUser.role === 'student') {
          const studentPayments = allFeePayments.filter(p => p.student_id === currentUser.id);
          if (studentPayments.length > 0) {
            feesHTML += `
              <div style="margin-top: 40px;">
                <h3 style="margin-bottom: 20px; color: #333;">Payment History</h3>
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Transaction ID</th>
                        <th>Status</th>
                        <th>Receipt</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${studentPayments.map(payment => `
                        <tr>
                          <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
                          <td>‚Çπ${payment.amount.toLocaleString()}</td>
                          <td>${payment.transaction_id}</td>
                          <td style="color: #43e97b; font-weight: bold;">‚úì Success</td>
                          <td>
                            <button class="action-btn" onclick="downloadPaymentReceipt('${payment.__backendId}')" style="background: #4facfe; color: white; font-size: 12px; padding: 5px 10px;">
                              üìÑ Download
                            </button>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          }
        }
      }
      
      feesContent.innerHTML = feesHTML;
    }

    // Pay fees function
    async function payFees(studentBackendId, maxAmount) {
      const student = allStudents.find(s => s.__backendId === studentBackendId);
      if (!student) return;
      
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">üí≥ Pay Fees - ${student.name}</h2>
            <span class="close-btn" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <div style="margin-bottom: 20px;">
            <div style="background: linear-gradient(135deg, #0C2B4E 0%, #1A3D64 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 10px 0;">Payment Details</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="opacity: 0.8; font-size: 14px;">Student</div>
                  <div style="font-weight: bold;">${student.name} (${student.roll_number})</div>
                </div>
                <div>
                  <div style="opacity: 0.8; font-size: 14px;">Outstanding Balance</div>
                  <div style="font-weight: bold; font-size: 20px;">‚Çπ${maxAmount.toLocaleString()}</div>
                </div>
              </div>
            </div>
          </div>
          <form onsubmit="processPayment(event, '${studentBackendId}')">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Payment Method</label>
                <select class="form-input" id="paymentMethod" required>
                  <option value="">Select Payment Method</option>
                  <option value="upi">UPI Payment</option>
                  <option value="card">Credit/Debit Card</option>
                  <option value="netbanking">Net Banking</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Amount to Pay (‚Çπ)</label>
                <input type="number" class="form-input" id="paymentAmount" min="1" max="${maxAmount}" placeholder="Enter amount" required>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                  You can pay any amount up to ‚Çπ${maxAmount.toLocaleString()}
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button type="button" onclick="setPaymentAmount(1000)" style="padding: 8px 15px; background: #B2B0E8; color: #0C2B4E; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">‚Çπ1,000</button>
              <button type="button" onclick="setPaymentAmount(5000)" style="padding: 8px 15px; background: #B2B0E8; color: #0C2B4E; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">‚Çπ5,000</button>
              <button type="button" onclick="setPaymentAmount(10000)" style="padding: 8px 15px; background: #B2B0E8; color: #0C2B4E; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">‚Çπ10,000</button>
              <button type="button" onclick="setPaymentAmount(${maxAmount})" style="padding: 8px 15px; background: #7A85C1; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">Full Amount</button>
            </div>
            <button type="submit" class="save-btn" style="background: linear-gradient(135deg, #1A2A80 0%, #3B38A0 100%); margin-top: 20px;">
              üí≥ Proceed to Pay
            </button>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Set payment amount helper
    function setPaymentAmount(amount) {
      const input = document.getElementById('paymentAmount');
      const maxAmount = parseFloat(input.getAttribute('max'));
      input.value = Math.min(amount, maxAmount);
    }

    // Process payment
    async function processPayment(event, studentBackendId) {
      event.preventDefault();

      const student = allStudents.find(s => s.__backendId === studentBackendId || s.id === studentBackendId);
      if (!student) return;

      const paymentMethod = document.getElementById('paymentMethod').value;
      const amount = parseFloat(document.getElementById('paymentAmount').value);
      const modal = event.target.closest('.modal');

      // Validate amount
      const maxAmount = student.fees_total - student.fees_paid;
      if (amount <= 0 || amount > maxAmount) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f8d7da; color: #721c24; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;';
        errorDiv.textContent = `Please enter a valid amount between ‚Çπ1 and ‚Çπ${maxAmount.toLocaleString()}`;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 3000);
        return;
      }

      // Show processing
      const submitBtn = event.target.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing Payment...';
      }

      try {
        // Simulate payment processing (replace with real gateway integration as needed)
        await new Promise(res => setTimeout(res, 1200));
        const transactionId = 'TXN' + Date.now();

        // Create payment record
        const paymentData = {
          type: 'fee_payment',
          student_id: student.id || student.__backendId || student.roll_number,
          student_backend_id: student.__backendId || student.id,
          student_name: student.name,
          student_roll: student.roll_number,
          amount: amount,
          payment_method: paymentMethod,
          transaction_id: transactionId,
          payment_date: new Date().toISOString(),
          status: 'success',
          timestamp: new Date().toISOString(),
          id: Date.now().toString()
        };

        // Save payment record
        const createResult = await window.dataSdk.create(paymentData);
        // If create returned an id, attach it
        if (createResult && createResult.id) {
          paymentData.__backendId = createResult.id;
        }

        // Update student fees safely: merge existing student object
        const updatedStudent = Object.assign({}, student, { fees_paid: (parseFloat(student.fees_paid) || 0) + amount });
        // Persist updated student (use backend id if available)
        const studentBackendId = student.__backendId || student.id;
        await window.dataSdk.update(studentBackendId, updatedStudent);

        // Refresh local caches from storage SDK to ensure consistency
        if (typeof window.dataSdk.readAll === 'function') {
          const stores = window.dataSdk.readAll();
          allStudents = stores.students || [];
          allTeachers = stores.teachers || [];
          allEvents = stores.events || [];
          allMessages = stores.messages || [];
          allFeePayments = stores.fee_payments || [];
          allAttendance = stores.attendance || [];
        } else {
          // best-effort: update in-memory
          // add payment to allFeePayments and update student in allStudents
          allFeePayments.push(paymentData);
          const idx = allStudents.findIndex(s => s.__backendId === (student.__backendId || student.id));
          if (idx !== -1) allStudents[idx] = updatedStudent;
        }

        // Remove modal
        if (modal) modal.remove();

        // Re-render UI parts that depend on fees
        updateDashboard();
        updateFeesTab();

        // Show success message with transaction details
        const successDiv = document.createElement('div');
        successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4edda; color: #155724; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;';
        successDiv.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">Payment Successful! üéâ</div>
          <div style="font-size: 14px;">Amount: ‚Çπ${amount.toLocaleString()}</div>
          <div style="font-size: 14px;">Transaction ID: ${transactionId}</div>
        `;
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 5000);

      } catch (err) {
        console.error('Payment processing failed', err);
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #fee; color: #c33; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;';
        errorDiv.textContent = 'Payment failed. Please try again.';
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 4000);
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Proceed to Pay';
        }
      }
    }

      
      // Show processing
      const submitBtn = event.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing Payment...';
      
      // Simulate payment processing
      setTimeout(async () => {
        const transactionId = 'TXN' + Date.now();
        
        // Create payment record
        const paymentData = {
          type: 'fee_payment',
          student_id: student.id,
          student_name: student.name,
          student_roll: student.roll_number,
          amount: amount,
          payment_method: paymentMethod,
          transaction_id: transactionId,
          payment_date: new Date().toISOString(),
          status: 'success',
          timestamp: new Date().toISOString(),
          id: Date.now().toString()
        };
        
        await window.dataSdk.create(paymentData);
        
        // Update student fees
        const updatedStudent = {
          ...student,
          fees_paid: student.fees_paid + amount
        };
        
        await window.dataSdk.update(updatedStudent);
        
        modal.remove();
        
        // Show success message
        const successDiv = document.createElement('div');
        successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #d4edda; color: #155724; padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000;';
        successDiv.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">Payment Successful! üéâ</div>
          <div style="font-size: 14px;">Amount: ‚Çπ${amount.toLocaleString()}</div>
          <div style="font-size: 14px;">Transaction ID: ${transactionId}</div>
        `;
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 5000);
        
      }, 2000);
    

    // Download receipt function
    function downloadReceipt(studentBackendId) {
      const student = allStudents.find(s => s.__backendId === studentBackendId);
      if (!student) return;
      
      generateReceipt(student, student.fees_paid, 'FEES_RECEIPT_' + Date.now());
    }

    // Download payment receipt
    function downloadPaymentReceipt(paymentBackendId) {
      const payment = allFeePayments.find(p => p.__backendId === paymentBackendId);
      if (!payment) return;
      
      const student = allStudents.find(s => s.id === payment.student_id);
      if (!student) return;
      
      generateReceipt(student, payment.amount, payment.transaction_id, payment.payment_date);
    }

    // Generate receipt
    function generateReceipt(student, amount, transactionId, paymentDate = null) {
      const receiptDate = paymentDate ? new Date(paymentDate) : new Date();
      
      const receiptContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Fee Payment Receipt</title>
          <style>
            body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
            .logo { font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 10px; }
            .college-name { font-size: 18px; color: #333; }
            .receipt-title { font-size: 20px; font-weight: bold; text-align: center; margin: 30px 0; color: #333; }
            .details { margin: 20px 0; }
            .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
            .detail-label { font-weight: bold; }
            .amount-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
            .total-amount { font-size: 24px; font-weight: bold; color: #43e97b; text-align: center; }
            .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #666; }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="logo">üìö SMS 6.0</div>
            <div class="college-name">Student Management System - Version 6.0</div>
            <div>B.Sc.IT Department - Advanced Edition</div>
          </div>
          
          <div class="receipt-title">FEE PAYMENT RECEIPT</div>
          
          <div class="details">
            <div class="detail-row">
              <span class="detail-label">Receipt No:</span>
              <span>${transactionId}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Date:</span>
              <span>${receiptDate.toLocaleDateString()}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Student Name:</span>
              <span>${student.name}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Roll Number:</span>
              <span>${student.roll_number}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Department:</span>
              <span>${student.department}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Email:</span>
              <span>${student.email}</span>
            </div>
          </div>
          
          <div class="amount-section">
            <div class="detail-row">
              <span class="detail-label">Fee Type:</span>
              <span>Semester Fees</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Amount Paid:</span>
              <span>‚Çπ${amount.toLocaleString()}</span>
            </div>
            <div class="total-amount">
              Total: ‚Çπ${amount.toLocaleString()}
            </div>
          </div>
          
          <div class="footer">
            <p><strong>Thank you for your payment!</strong></p>
            <p>This is a computer generated receipt.</p>
            <p>For any queries, contact the accounts department.</p>
          </div>
        </body>
        </html>
      `;
      
      // Create and download the receipt
      const blob = new Blob([receiptContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Fee_Receipt_${student.roll_number}_${transactionId}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initialize app on load
    showLoading();
    initializeApp();
  
/* --- START: Compatibility helpers & fixed handlers injected by assistant --- */
async function sdkCreate(record) {
  if (!window.dataSdk || !window.dataSdk.create) {
    console.warn('dataSdk.create not present ‚Äî storing locally.');
    // emulate successful create
    const id = 'local_' + Date.now();
    return { isOk: true, id };
  }
  try {
    const res = await window.dataSdk.create(record);
    return res && res.isOk ? res : { isOk: false };
  } catch (e) {
    console.warn('sdkCreate error', e);
    return { isOk: false };
  }
}

async function sdkUpdate(backendId, record) {
  if (!window.dataSdk || !window.dataSdk.update) {
    console.warn('dataSdk.update not present ‚Äî local update.');
    return { isOk: true };
  }
  try {
    // try common signature
    return await window.dataSdk.update(backendId, record);
  } catch (e1) {
    try {
      return await window.dataSdk.update(Object.assign({}, record, { __backendId: backendId }));
    } catch (e2) {
      try {
        return await window.dataSdk.update(record);
      } catch (e3) {
        console.warn('sdkUpdate all attempts failed', e1, e2, e3);
        return { isOk: false };
      }
    }
  }
}

async function sdkDelete(backendIdOrRecord) {
  if (!window.dataSdk || !window.dataSdk.delete) {
    console.warn('dataSdk.delete not present ‚Äî local delete.');
    return { isOk: true };
  }
  try {
    return await window.dataSdk.delete(backendIdOrRecord);
  } catch (e1) {
    try {
      return await window.dataSdk.delete({ __backendId: backendIdOrRecord });
    } catch (e2) {
      console.warn('sdkDelete failed', e1, e2);
      return { isOk: false };
    }
  }
}

function showSuccessTemporary(msg) {
  const t = document.createElement('div');
  t.style.cssText = 'position:fixed;top:20px;right:20px;background:#d4edda;color:#155724;padding:10px 16px;border-radius:8px;z-index:3000';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), 2000);
}

/* Fix Student submit (create or update) */
async function handleStudentSubmit(event) {
  event.preventDefault();
  const saveBtn = document.getElementById('saveStudentBtn');
  const errorDiv = document.getElementById('modalError');
  const successDiv = document.getElementById('modalSuccess');
  errorDiv.style.display = 'none';
  successDiv.style.display = 'none';
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';

  const studentData = {
    type: 'student',
    roll_number: (document.getElementById('modalRollNumber').value || '').trim(),
    name: (document.getElementById('modalName').value || '').trim(),
    email: (document.getElementById('modalEmail').value || '').trim().toLowerCase(),
    password: (document.getElementById('modalPassword').value || ''),
    department: (document.getElementById('modalDepartment').value || ''),
    semester: 'III Semester',
    phone: (document.getElementById('modalPhone').value || ''),
    address: (document.getElementById('modalAddress').value || ''),
    attendance_percentage: Number(document.getElementById('modalAttendance').value || 0),
    cgpa: Number(document.getElementById('modalCGPA').value || 0),
    fees_paid: Number(document.getElementById('modalFeesPaid').value || 0),
    fees_total: Number(document.getElementById('modalFeesTotal').value || 0),
    books_borrowed: Number(document.getElementById('modalBooks').value || 0),
    assignments_completed: Number((document.getElementById('modalAssignmentsCompleted') && document.getElementById('modalAssignmentsCompleted').value) || 0),
    assignments_total: Number((document.getElementById('modalAssignmentsTotal') && document.getElementById('modalAssignmentsTotal').value) || 10),
    role: 'student',
    timestamp: new Date().toISOString()
  };

  try {
    let res;
    if (currentEditingStudent) {
      res = await sdkUpdate(currentEditingStudent.__backendId || currentEditingStudent.id, studentData);
      if (res && res.isOk) {
        Object.assign(currentEditingStudent, studentData);
      } else throw new Error('Update failed');
    } else {
      // create
      res = await sdkCreate(Object.assign({}, studentData, { id: Date.now().toString() }));
      if (res && res.isOk) {
        const localId = res.id || ('local_' + Date.now());
        allStudents.unshift(Object.assign({}, studentData, { __backendId: localId, id: localId }));
      } else throw new Error('Create failed');
    }

    successDiv.textContent = currentEditingStudent ? 'Student updated successfully!' : 'Student added successfully!';
    successDiv.style.display = 'block';
    updateStudentsTable();
    updateAllTabs();
    updateOverview();
    setTimeout(() => { closeStudentModal(); }, 800);
  } catch (err) {
    console.error('handleStudentSubmit error', err);
    errorDiv.textContent = 'Failed to save student. Try again.';
    errorDiv.style.display = 'block';
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Student';
    currentEditingStudent = null;
  }
}

/* Fix Teacher submit (admin-only) */
async function handleTeacherSubmit(event) {
  event.preventDefault();
  const saveBtn = document.getElementById('saveTeacherBtn');
  const errorDiv = document.getElementById('teacherModalError');
  const successDiv = document.getElementById('teacherModalSuccess');
  errorDiv.style.display = 'none';
  successDiv.style.display = 'none';
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';

  const teacherData = {
    type: 'teacher',
    teacher_id: (document.getElementById('teacherModalId').value || '').trim(),
    name: (document.getElementById('teacherModalName').value || '').trim(),
    email: (document.getElementById('teacherModalEmail').value || '').trim().toLowerCase(),
    password: (document.getElementById('teacherModalPassword').value || ''),
    subject: (document.getElementById('teacherModalSubject').value || ''),
    phone: (document.getElementById('teacherModalPhone').value || ''),
    department: (document.getElementById('teacherModalDepartment').value || ''),
    experience: Number(document.getElementById('teacherModalExperience').value || 0),
    attendance_percentage: 95,
    role: 'teacher',
    timestamp: new Date().toISOString()
  };

  try {
    let res;
    if (currentEditingTeacher) {
      res = await sdkUpdate(currentEditingTeacher.__backendId || currentEditingTeacher.id, teacherData);
      if (res && res.isOk) Object.assign(currentEditingTeacher, teacherData);
      else throw new Error('Update failed');
    } else {
      res = await sdkCreate(Object.assign({}, teacherData, { id: Date.now().toString() }));
      if (res && res.isOk) {
        const localId = res.id || ('local_' + Date.now());
        allTeachers.unshift(Object.assign({}, teacherData, { __backendId: localId, id: localId }));
      } else throw new Error('Create failed');
    }

    successDiv.textContent = currentEditingTeacher ? 'Teacher updated successfully!' : 'Teacher added successfully!';
    successDiv.style.display = 'block';
    updateTeachersTable();
    updateAllTabs();
    updateOverview();
    setTimeout(() => { closeTeacherModal(); }, 900);
  } catch (err) {
    console.error('handleTeacherSubmit error', err);
    errorDiv.textContent = 'Failed to save teacher. Try again.';
    errorDiv.style.display = 'block';
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Teacher';
    currentEditingTeacher = null;
  }
}

/* Event modal and submit */
function showEventModal(target) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.display = 'block';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üìÖ Send Event to ${target === 'students' ? 'Students' : 'Teachers'}</h2>
        <span class="close-btn" style="cursor:pointer">&times;</span>
      </div>
      <form id="__eventForm">
        <div class="form-group"><label>Event Title</label><input id="eventTitle" class="form-input" required></div>
        <div class="form-group"><label>Description</label><textarea id="eventDescription" class="form-input" rows="4" required></textarea></div>
        <div class="form-grid">
          <div class="form-group"><label>Date</label><input id="eventDate" type="date" class="form-input" required></div>
          <div class="form-group"><label>Venue</label><input id="eventVenue" class="form-input" required></div>
        </div>
        <div style="margin-top:12px;"><button type="submit" class="save-btn">Send Event</button> <button type="button" class="back-btn">Cancel</button></div>
      </form>
    </div>`;
  document.body.appendChild(modal);
  modal.querySelector('.close-btn').onclick = () => modal.remove();
  modal.querySelector('.back-btn').onclick = () => modal.remove();

  modal.querySelector('form').onsubmit = (e) => handleEventSubmit(e, target, modal);
}

async function handleEventSubmit(e, target, modalEl) {
  e.preventDefault();
  const title = (document.getElementById('eventTitle').value || '').trim();
  const desc = (document.getElementById('eventDescription').value || '').trim();
  const date = (document.getElementById('eventDate').value || '');
  const venue = (document.getElementById('eventVenue').value || '');

  const eventObj = {
    type: 'event',
    event_title: title,
    event_description: desc,
    event_date: date,
    event_venue: venue,
    event_target: target,
    event_sender: currentUser ? currentUser.role : 'unknown',
    timestamp: new Date().toISOString(),
    id: Date.now().toString()
  };

  try {
    const res = await sdkCreate(eventObj);
    if (res && res.isOk) {
      allEvents.unshift(Object.assign({}, eventObj, { __backendId: res.id || ('local_' + Date.now()) }));
      updateEventsTab();
      if (modalEl) modalEl.remove();
      showSuccessTemporary('Event sent');
    } else {
      throw new Error('create failed');
    }
  } catch (err) {
    console.error('handleEventSubmit error', err);
    alert('Failed to send event');
  }
}

/* Message modal and submit */
function showMessageModal(target) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.display = 'block';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üí¨ Send Message to ${target === 'students' ? 'Students' : 'Teachers'}</h2>
        <span class="close-btn" style="cursor:pointer">&times;</span>
      </div>
      <form id="__messageForm">
        <div class="form-group"><label>Title</label><input id="messageTitle" class="form-input" required></div>
        <div class="form-group"><label>Message</label><textarea id="messageContent" class="form-input" rows="4" required></textarea></div>
        <div style="margin-top:12px;"><button type="submit" class="save-btn">Send Message</button> <button type="button" class="back-btn">Cancel</button></div>
      </form>
    </div>`;
  document.body.appendChild(modal);
  modal.querySelector('.close-btn').onclick = () => modal.remove();
  modal.querySelector('.back-btn').onclick = () => modal.remove();

  modal.querySelector('form').onsubmit = (e) => handleMessageSubmit(e, target, modal);
}

async function handleMessageSubmit(e, target, modalEl) {
  e.preventDefault();
  const title = (document.getElementById('messageTitle').value || '').trim();
  const content = (document.getElementById('messageContent').value || '').trim();
  const messageObj = {
    type: 'message',
    message_title: title,
    message_content: content,
    message_target: target,
    message_sender: currentUser ? currentUser.role : 'unknown',
    timestamp: new Date().toISOString(),
    id: Date.now().toString()
  };

  try {
    const res = await sdkCreate(messageObj);
    if (res && res.isOk) {
      allMessages.unshift(Object.assign({}, messageObj, { __backendId: res.id || ('local_' + Date.now()) }));
      updateMessagesTab();
      if (modalEl) modalEl.remove();
      showSuccessTemporary('Message sent');
    } else {
      throw new Error('create failed');
    }
  } catch (err) {
    console.error('handleMessageSubmit error', err);
    alert('Failed to send message');
  }
}
/* --- END injected helpers & fixes --- */

</script>
  </div>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99ab1190f5b2b294',t:'MTc2MjUwMDAzMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>